name: Backup & Cleanup

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_run:      # ç›‘å¬ç¬¬äºŒä¸ªå·¥ä½œæµ (ç”Ÿæˆæ–‡æ¡£) å®Œæˆåè§¦å‘
    workflows: ["Generate Sub-READMEs"]
    types:
      - completed

permissions:
  contents: write # å…è®¸åˆ›å»º Release
  actions: write  # å…è®¸åˆ é™¤ Workflow Runs

jobs:
  backup-and-release:
    runs-on: ubuntu-latest
    # ä»…åœ¨â€œç”Ÿæˆæ–‡æ¡£â€æˆåŠŸåï¼Œæˆ–è€…æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: æ£€æŸ¥ä»£ç ä»“åº“
        uses: actions/checkout@v4

      - name: è·å–æ—¶é—´æˆ³
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_ENV

      - name: ç”Ÿæˆæ˜ç»†å¹¶æ‰“åŒ…
        run: |
          sudo apt-get install -y zip

          # --- 1. ç”Ÿæˆ Release æè¿°æ–‡æ¡£ (åŒ…å«æ–‡ä»¶æ˜ç»†) ---
          echo "## ğŸ“¦ å¤‡ä»½æ–‡ä»¶æ˜ç»† (File Manifest)" > release_body.md
          echo "> å¤‡ä»½æ—¶é—´ (Time): ${{ env.TIMESTAMP }}" >> release_body.md
          echo "" >> release_body.md
          echo "### ğŸ“„ åŒ…å«æ–‡ä»¶åˆ—è¡¨ï¼š" >> release_body.md
          echo '```text' >> release_body.md
          
          # æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
          # æ’é™¤ .git, .github ç›®å½•
          # æ’é™¤ release_body.md å’Œ .zip æ–‡ä»¶è‡ªèº«
          # sed 's|^./||' ç”¨äºå»æ‰è·¯å¾„å¼€å¤´çš„ ./
          find . -type f \
            -not -path '*/.git/*' \
            -not -path '*/.github/*' \
            -not -name "release_body.md" \
            -not -name "*.zip" \
            | sort | sed 's|^./||' >> release_body.md
            
          echo '```' >> release_body.md

          # --- 2. æ‰“åŒ…æ–‡ä»¶ ---
          # -x æ’é™¤å·¥ä½œæµæ–‡ä»¶ã€gitæ–‡ä»¶ã€æ ¹ç›®å½•READMEå’Œä¸´æ—¶æè¿°æ–‡ä»¶
          zip -r "Config_Backup_${{ env.TIMESTAMP }}.zip" . -x ".git/*" ".github/*" "README.md" "release_body.md"

          echo "âœ… æ‰“åŒ…å®Œæˆï¼Œæ˜ç»†å·²ç”Ÿæˆã€‚"

      - name: å‘å¸ƒ Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "backup-${{ env.TIMESTAMP }}"
          name: "ğŸ“… è‡ªåŠ¨å¤‡ä»½: ${{ env.TIMESTAMP }}"
          body_path: release_body.md  # ä½¿ç”¨åˆšæ‰ç”Ÿæˆçš„æ˜ç»†æ–‡ä»¶ä½œä¸º Release å†…å®¹
          files: Config_Backup_${{ env.TIMESTAMP }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup-workflows:
    runs-on: ubuntu-latest
    needs: backup-and-release # å¤‡ä»½æˆåŠŸåå†æ¸…ç†
    steps:
      - name: å¼ºåŠ›æ¸…ç†æ—§è®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0        # 0 = åˆ é™¤æ‰€æœ‰éä»Šå¤©çš„è®°å½•
          keep_minimum_runs: 1  # è‡³å°‘ä¿ç•™æœ€æ–°çš„ 1 æ¡æˆåŠŸè®°å½•
          delete_workflow_pattern: "Update File Test" # æ¸…ç†ä¸»æŠ“å–ä»»åŠ¡çš„è®°å½•
